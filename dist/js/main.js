!function(e){"use strict";e.App={Collections:{clients:[]},Views:{},Models:{},Routers:{}}}(window),function(e){"use strict";function t(e,t){this.el=t,this.date=e,this.render(),this.start()}t.prototype.calculateTime=function(){var e=Date.parse(this.date),t=new Date(e),n=new Date,i=t-n;i/=1e3;var o=Math.floor(i%60);i/=60;var s=Math.floor(i%60);i/=60;var r=Math.floor(i%24);i/=24;var a=Math.floor(i%30);i/=30;var l=Math.floor(i%12),d=Math.floor(i/12),c={years:d,months:l,days:a,hours:r,minutes:s,seconds:o},h="";for(var u in c)h+=c[u]+" : "+u+", ";return h},t.prototype.render=function(){this.el.textContent=this.calculateTime()},t.prototype.start=function(){var e=this;this.id=setInterval(function(){e.render()},1e3)},t.prototype.stop=function(){clearTimeout(this.id)},e.Views.EstimatedDateElement=t}(App),function(e){"use strict";function t(){this.eventCollection=[]}t.prototype.addEventListener=function(e,t){this.eventCollection.push({eventType:e,eventHandler:t})},t.prototype.triggerEvent=function(e,t){this.eventCollection.forEach(function(n){e===n.eventType&&n.eventHandler(t)})},e.Views.EventCollection=t}(App),function(e){"use strict";function t(e){this.el=document.createElement("DIV"),this.el.className="popup",this.collection=e.collection,this.loadingSettings=e.loadingSettings||{},this.model=e.model,this.table=e.table,this.addFormListeners(this.el)}t.prototype.template=function(e,t){var n=document.createElement("DIV");n.className="form";var i=document.createElement("H3");i.textContent="Add New Client",n.appendChild(i);var o=document.createElement("LABEL");o.setAttribute("for","name-input"),o.textContent="Enter client Name",n.appendChild(o);var s=document.createElement("INPUT");s.setAttribute("type","text"),s.value=t.name||"",s.id="name-input",n.appendChild(s);var r=document.createElement("LABEL");r.setAttribute("for","phone-input"),r.textContent="Enter client Phone",n.appendChild(r);var a=document.createElement("LABEL");a.setAttribute("for","email-input"),a.textContent="Enter client Email",n.appendChild(a);var l=document.createElement("INPUT");l.setAttribute("type","email"),l.value=t.email||"",l.id="email-input",n.appendChild(l);var d=document.createElement("LABEL");d.setAttribute("for","date-input"),d.textContent="Enter estimated time",n.appendChild(d);var c=document.createElement("INPUT");c.setAttribute("type","date"),c.value=t.date||"",c.id="date-input",n.appendChild(c);var h=document.createElement("DIV");h.className="button-group";var u=document.createElement("BUTTON");u.className="add-btn",u.textContent="Add",h.appendChild(u);var p=document.createElement("BUTTON");p.className="edit-btn",p.textContent="Save",p.style.display="none",h.appendChild(p);var m=document.createElement("BUTTON");m.className="cancel-btn",m.textContent="Cancel",h.appendChild(m),n.appendChild(h),e.appendChild(n)},t.prototype.render=function(){return this.template(this.el,this.model),this.cacheSelectors(),this.el},t.prototype.addFormListeners=function(e){e.addEventListener("click",this.formEventHandler.bind(this))},t.prototype.formEventHandler=function(e){this.cacheSelectors(),"add-btn"===e.target.className&&this.addNewClient(),"cancel-btn"===e.target.className&&this.clearForm(),"edit-btn"===e.target.className&&this.saveEdit()},t.prototype.cacheSelectors=function(){this.name=document.getElementById("name-input"),this.phone=document.getElementById("phone-input"),this.email=document.getElementById("email-input"),this.date=document.getElementById("date-input")},t.prototype.saveEdit=function(){var t={admin:!1,id:this.model.id,name:this.name.value,email:this.email.value,date:this.date.value||"2030"},n=this;e.Request.editUser({success:n.onEditSuccess.bind(n),error:n.onEditError.bind(n)},{model:t})},t.prototype.onEditSuccess=function(t){var n;this.collection.forEach(function(e,i){+t.id===e.id&&(n=i)}),t=new e.Models.User(t),this.collection.splice(n,1,t),this.table.tBody.render(),this.clearForm(),console.log("The model with id: "+t.id+"was edited")},t.prototype.onEditError=function(e){var t=e.id;console.log("Error with editing model whith id:"+t)},t.prototype.addNewClient=function(){var t=this.collection.length+1,n={id:t,name:this.name.value,email:this.email.value,date:this.date.value||"2030"},i=this;e.Request.addUser({success:i.onSuccessLoad.bind(i),error:i.onErrorLoad},{model:n})},t.prototype.onSuccessLoad=function(e){this.collection.length=0,this.table.tBody.el.scrollTop=0,this.loadingSettings.page=0,this.loadingSettings.allPagesLoaded=!1,console.log(e),this.collection.length=0,this.table.tBody.triggerEvent("loadingStart"),this.clearForm()},t.prototype.onErrorLoad=function(e){console.log(e)},t.prototype.clearForm=function(){this.name.value="",this.email.value="",this.date.value="",this.removePopup()},t.prototype.removePopup=function(){var e=document.querySelector(".popup");document.body.removeChild(e)},e.Views.FormView=t}(App),function(e){"use strict";function t(e){this.el=document.createElement("THEAD"),this.el.className="tableHeader",this.collection=e.collection,this.sortBy=e.sortBy,this.reverse=e.reverse,this.table=e.table,this.render(),this.addHeaderListeners.call(this)}t.prototype.templ=function(e){var t=document.createElement("TR"),n=document.createDocumentFragment(),i=document.createElement("TH");i.id="id",i.dataset.sortBy="id",i.textContent="ID",n.appendChild(i);var o=document.createElement("TH");o.id="name",o.dataset.sortBy="name",o.textContent="Name",n.appendChild(o);var s=document.createElement("TH");s.id="email",s.dataset.sortBy="email",s.textContent="Email",n.appendChild(s);var r=document.createElement("TH");r.id="date",r.dataset.sortBy="date",r.textContent="Estimated time",n.appendChild(r);var a=document.createElement("TH");a.id="delete",a.textContent="Delete",n.appendChild(a);var l=document.createElement("TH");l.id="edit",l.textContent="Edit",n.appendChild(l),t.appendChild(n),e.appendChild(t)},t.prototype.render=function(){return this.templ(this.el),this},t.prototype.addHeaderListeners=function(){this.el.addEventListener("click",this.headerFilterHandler.bind(this))},t.prototype.headerFilterHandler=function(e){function t(){for(var t=e.target.parentElement.children,n=0;n<t.length;n++)t[n].classList.remove("active")}return"TH"===e.target.tagName&&"delete"!==e.target.id&&"edit"!==e.target.id&&void("active"===e.target.className?this.table.tBody.triggerEvent("reverse"):(t(),e.target.classList.add("active"),this.table.tBody.triggerEvent("columnSort",e.target.dataset.sortBy)))},e.Views.HeaderItem=t}(App),function(e){"use strict";function t(){var e=new App.Views.AppLayout;e.loadUsers(),e.render()}e.addEventListener("DOMContentLoaded",t)}(document),function(e){"use strict";function t(){this.collection=[],this.loadingSettings={loadingInProgress:!1,page:0,pageSize:10,allPagesLoaded:!1},this.usersTable=new e.Views.TableView({collection:this.collection,settings:this.loadingSettings}),this.tBody=this.usersTable.tBody,this.button=document.createElement("BUTTON"),this.tBody.addEventListener("edit",this.editModel.bind(this)),this.tBody.addEventListener("loadingStart",this.loadUsers.bind(this))}t.prototype.loadUsers=function(){var t=this;e.Request.loadUsers({success:t.onLoad.bind(t),error:t.onError.bind(t)},t.loadingSettings)},t.prototype.onLoad=function(t){var n=this;n.loadingSettings.totalItems=t.totalItems;var i=t.result,o=i.map(function(t){return new e.Models.User(t)});this.usersTable.tBody.triggerEvent("loadFinished",o)},t.prototype.onError=function(e){console.log(e)},t.prototype.createButton=function(){return this.button.className="addClient",this.button.textContent="Add Client",this.button.addEventListener("click",this.addClient.bind(this)),this.button},t.prototype.addClient=function(){var t=document.querySelector(".popup");if(t)return!1;var n=new e.Views.FormView({collection:this.collection,table:this.usersTable,loadingSettings:this.loadingSettings,model:{}});document.body.appendChild(n.render())},t.prototype.render=function(){document.body.appendChild(this.usersTable.render()),document.body.appendChild(this.createButton())},t.prototype.editModel=function(t){function n(){var e=document.querySelector(".popup");e.querySelector("h3").textContent="Edit Client",e.querySelector(".add-btn").style.display="none",e.querySelector(".edit-btn").style.display="inline"}var i=document.querySelector(".popup");if(i)return!1;var o=new e.Views.FormView({collection:this.collection,table:this.usersTable,model:t});document.body.appendChild(o.render()),n()},e.Views.AppLayout=t}(App,window),function(e){"use strict";var t="http://localhost:4000/";e.Request={loadUsers:function(n,i){return i=i||{},new e.Request.ServerRequest({method:"POST",URL:t+"users",params:i,settings:n})},addUser:function(n,i){return new e.Request.ServerRequest({method:"POST",URL:t+"user",settings:n,params:i})},deleteUser:function(n,i){return new e.Request.ServerRequest({method:"DELETE",URL:t+"user",settings:n,params:i})},getUser:function(n,i){return new e.Request.ServerRequest({method:"GET",URL:t+"user",settings:n,params:i})},editUser:function(n,i){return new e.Request.ServerRequest({method:"PUT",URL:t+"user",settings:n,params:i})}}}(App),function(e){"use strict";function t(e){this.el=document.createElement("TR"),this.el.className="client",this.model=e.model,this.el.dataset.id=this.model.id,this.id=this.model.id,this.render()}t.prototype.templ=function(e,t){var n=t.createTemplate();e.appendChild(n)},t.prototype.render=function(){return this.templ(this.el,this.model),this},t.prototype.destroy=function(){this.model.timeView.stop(),this.el.parentElement.removeChild(this.el)},e.Views.RowItem=t}(App),function(e){"use strict";function t(e){this.xhr=new XMLHttpRequest,this.method=e.method,this.URL=e.URL,this.settings=e.settings,this.params=e.params,this.success=this.settings.success,this.error=this.settings.error,this.model=this.params.model,this.id=this.params.id,this.requestString=this.createRequestString(this.params),this.requestBody="";var t=this;this.actions={GET:function(){t.URL+="?"+t.requestString},POST:function(){t.model?t.requestBody=t.createRequestString(t.model):t.requestBody=t.requestString},PUT:function(){t.requestBody=t.createRequestString(t.model)},DELETE:function(){t.requestBody=t.requestString}},this.actions[this.method](),this.xhr.open(this.method,this.URL,!0),this.xhr.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),this.xhr.addEventListener("readystatechange",this.readyStateChangeHandler.bind(this)),this.xhr.send(this.requestBody)}t.prototype.createRequestString=function(e){var t="";for(var n in e)t+=n+"="+encodeURIComponent(e[n]+"")+"&";return t},t.prototype.readyStateChangeHandler=function(){if(4===this.xhr.readyState){if(!(this.xhr.status>=200&&this.xhr.status<300)){var e="error: "+(this.xhr.status?this.xhr.statusText:"problems with request");return this.error(e)}var t=JSON.parse(this.xhr.responseText);this.success(t)}},e.Request.ServerRequest=t}(App),function(e){"use strict";function t(t){e.Views.EventCollection.call(this),this.el=document.createElement("TBODY"),this.el.className="tableBody",this.collection=t.collection,this.loadingSettings=t.settings,this.table=t.table,this.rowItems=[],this.el.addEventListener("click",this.delEditHandlers.bind(this)),this.el.addEventListener("scroll",this.scrollHandler.bind(this)),this.addEventListener("loadFinished",this.updateTable.bind(this)),this.addEventListener("reverse",this.reverse.bind(this)),this.addEventListener("columnSort",this.sort.bind(this)),this.render()}t.prototype=Object.create(e.Views.EventCollection.prototype),t.prototype.scrollHandler=function(){clearTimeout(this.scrollTimerId);var e=this;this.scrollTimerId=setTimeout(function(){e.loadingSettings.loadingInProgress||e.el.scrollHeight-(e.el.scrollTop+e.el.offsetHeight)<=500&&(!e.loadingSettings.totalItems||e.loadingSettings.totalItems>(e.loadingSettings.page+1)*e.loadingSettings.pageSize?(e.loadingSettings.page++,e.triggerEvent("loadingStart")):e.loadingSettings.allPagesLoaded=!0)},200)},t.prototype.updateTable=function(e){var t=this;e.forEach(function(e){t.collection.push(e)}),this.render()},t.prototype.clearTBody=function(){this.el.innerHTML="",this.rowItems.length=0},t.prototype.render=function(){if(this.clearTBody(),0===this.collection.length)this.el.innerHTML='<tr class="dummy"><td colspan ="7">There is no more clients</td></tr>';else{var t=this,n=document.createDocumentFragment();this.collection.forEach(function(i){var o=new e.Views.RowItem({model:i,collection:t.collection});t.rowItems.push(o),n.appendChild(o.el)}),this.el.appendChild(n)}return this.el},t.prototype.reverse=function(){this.collection.reverse(),this.render()},t.prototype.sort=function(e){switch(e){case"id":this.collection.sort(function(t,n){return+t[e]-+n[e]});break;case"date":this.collection.sort(function(t,n){var i=Date.parse(t[e]),o=Date.parse(n[e]);return i-o});break;default:this.collection.sort(function(t,n){return t[e]>n[e]?1:-1})}this.render()},t.prototype.delEditHandlers=function(t){if("delClient"===t.target.className&&this.deleteRow(t),"editClient"===t.target.className){var n=t.target.closest("TR"),i=+n.dataset.id;e.Request.getUser({success:this.onGetModel.bind(this),error:this.onDelEditError.bind(this)},{id:i})}},t.prototype.onGetModel=function(e){this.triggerEvent("edit",e)},t.prototype.deleteRow=function(t){var n=t.target.closest("TR");if("delClient"!==t.target.className)return!1;var i=this.findColIndex(n),o=+n.dataset.id;0===this.collection.length?this.render():e.Request.deleteUser({success:this.eraseRow.bind(this,n,i),error:this.onDelEditError.bind(this)},{id:o})},t.prototype.eraseRow=function(e,t,n){var i=this;10===this.collection.length&&i.scrollHandler();var o=this.findRowIndex(e);console.log("model with id: "+n.id+"was deleted"),this.collection.splice(t,1),this.rowItems[o].destroy(),this.rowItems.splice(o,1)},t.prototype.onDelEditError=function(e){console.log(e)},t.prototype.findRowIndex=function(e){var t;return this.rowItems.forEach(function(n,i){+e.dataset.id===n.model.id&&(t=i)}),t},t.prototype.findColIndex=function(e){var t;return this.collection.forEach(function(n,i){+e.dataset.id===n.id&&(t=i)}),t},e.Views.TableBody=t}(App),function(e){"use strict";function t(t){this.el=document.createElement("TABLE"),this.el.className="list",this.collection=t.collection,this.loadingSettings=t.settings,this.rowItems=[],this.tBody=new e.Views.TableBody({collection:this.collection,settings:this.loadingSettings,table:this}),this.header=new e.Views.HeaderItem({collection:this.collection,table:this})}t.prototype.addClient=function(e){this.collection.push(e),this.tBody.render()},t.prototype.render=function(){return this.createCaption(),this.el.appendChild(this.header.el),this.el.appendChild(this.tBody.render()),this.el},t.prototype.createCaption=function(){var e=document.createElement("CAPTION");e.textContent="Users List",this.el.appendChild(e)},e.Views.TableView=t}(App),function(){"use strict";function e(e){var t=this;this.id=e.id,this.name=e.name,this.admin=e.admin,this.email=e.email,this.date=e.date,this.template={idElement:function(){var e=document.createElement("TD");return e.className="client-id",e.textContent=t.id,e},nameElement:function(){var e=document.createElement("TD");return e.className="client-name",e.textContent=t.name,e},emailElement:function(){var e=document.createElement("TD");return e.className="client-email",e.textContent=t.email,e},dateElement:function(){var e=document.createElement("TD");return e.className="client-date",t.timeView=new App.Views.EstimatedDateElement(t.date,e),e},buttonElement:function(){var e=document.createElement("TD");e.className="client-delete";var t=document.createElement("BUTTON");return t.className="delClient",t.textContent="Delete client",e.appendChild(t),e},delElement:function(){var e=document.createElement("TD");e.className="edit-element";var t=document.createElement("BUTTON");return t.className="editClient",t.textContent="Edit client",e.appendChild(t),e}}}e.prototype.createTemplate=function(){var e=new DocumentFragment;for(var t in this.template)e.appendChild(this.template[t]());return e},App.Models.User=e}();