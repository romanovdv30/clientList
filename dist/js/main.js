!function(e){"use strict";e.App={Collections:{clients:[]},Views:{},Models:{},Routers:{}}}(window),function(e){"use strict";function t(e,t){this.el=t,this.date=e,this.render(),this.start()}t.prototype.calculateTime=function(){var e=Date.parse(this.date),t=new Date(e),n=new Date,i=t-n;i/=1e3;var s=Math.floor(i%60);i/=60;var o=Math.floor(i%60);i/=60;var r=Math.floor(i%24);i/=24;var a=Math.floor(i%30);i/=30;var d=Math.floor(i%12),l=Math.floor(i/12),c={years:l,months:d,days:a,hours:r,minutes:o,seconds:s},h="";for(var u in c)h+=c[u]+" : "+u+", ";return h},t.prototype.render=function(){this.el.textContent=this.calculateTime()},t.prototype.start=function(){var e=this;this.id=setInterval(function(){e.render()},1e3)},t.prototype.stop=function(){clearTimeout(this.id)},e.Views.EstimatedDateElement=t}(App),function(e){"use strict";function t(){this.eventCollection=[]}t.prototype.addEventListener=function(e,t){this.eventCollection.push({eventType:e,eventHandler:t})},t.prototype.triggerEvent=function(e,t){this.eventCollection.forEach(function(n){e===n.eventType&&n.eventHandler(t)})},e.Views.EventCollection=t}(App),function(e){"use strict";function t(e){this.el=document.createElement("DIV"),this.el.className="popup",this.collection=e.collection,this.loadingSettings=e.loadingSettings||{},this.model=e.model,this.table=e.table,this.addFormListeners(this.el)}t.prototype.template=function(e,t){var n=document.createElement("DIV");n.className="form";var i=document.createElement("H3");i.textContent="Add New Client",n.appendChild(i);var s=document.createElement("LABEL");s.setAttribute("for","name-input"),s.textContent="Enter client Name",n.appendChild(s);var o=document.createElement("INPUT");o.setAttribute("type","text"),o.value=t.name||"",o.id="name-input",n.appendChild(o);var r=document.createElement("LABEL");r.setAttribute("for","phone-input"),r.textContent="Enter client Phone",n.appendChild(r);var a=document.createElement("LABEL");a.setAttribute("for","email-input"),a.textContent="Enter client Email",n.appendChild(a);var d=document.createElement("INPUT");d.setAttribute("type","email"),d.value=t.email||"",d.id="email-input",n.appendChild(d);var l=document.createElement("LABEL");l.setAttribute("for","date-input"),l.textContent="Enter estimated time",n.appendChild(l);var c=document.createElement("INPUT");c.setAttribute("type","date"),c.value=t.date||"",c.id="date-input",n.appendChild(c);var h=document.createElement("DIV");h.className="button-group";var u=document.createElement("BUTTON");u.className="add-btn",u.textContent="Add",h.appendChild(u);var p=document.createElement("BUTTON");p.className="edit-btn",p.textContent="Save",p.style.display="none",h.appendChild(p);var m=document.createElement("BUTTON");m.className="cancel-btn",m.textContent="Cancel",h.appendChild(m),n.appendChild(h),e.appendChild(n)},t.prototype.render=function(){return this.template(this.el,this.model),this.cacheSelectors(),this.el},t.prototype.addFormListeners=function(e){e.addEventListener("click",this.formEventHandler.bind(this))},t.prototype.formEventHandler=function(e){this.cacheSelectors(),"add-btn"===e.target.className&&this.addNewClient(),"cancel-btn"===e.target.className&&this.clearForm(),"edit-btn"===e.target.className&&this.saveEdit()},t.prototype.cacheSelectors=function(){this.name=document.getElementById("name-input"),this.phone=document.getElementById("phone-input"),this.email=document.getElementById("email-input"),this.date=document.getElementById("date-input")},t.prototype.saveEdit=function(){var t={admin:!1,id:this.model.id,name:this.name.value,email:this.email.value,date:this.date.value||"2030"},n=this;e.Request.editUser({success:n.onEditSuccess.bind(n),error:n.onEditError.bind(n)},{model:t})},t.prototype.onEditSuccess=function(t){var n;this.collection.forEach(function(e,i){+t.id===e.id&&(n=i)}),t=new e.Models.User(t),this.collection.splice(n,1,t),this.table.tBody.render(),this.clearForm(),console.log("The model with id: "+t.id+"was edited")},t.prototype.onEditError=function(e){var t=e.id;console.log("Error with editing model whith id:"+t)},t.prototype.addNewClient=function(){var t=this.collection.length+1,n={id:t,name:this.name.value,email:this.email.value,date:this.date.value||"2030"},i=this;e.Request.addUser({success:i.onSuccessLoad.bind(i),error:i.onErrorLoad},{model:n})},t.prototype.onSuccessLoad=function(e){this.collection.length=0,this.table.tBody.el.scrollTop=0,this.loadingSettings.page=0,this.loadingSettings.allPagesLoaded=!1,console.log(e),this.collection.length=0,this.table.tBody.triggerEvent("loadingStart"),this.clearForm()},t.prototype.onErrorLoad=function(e){console.log(e)},t.prototype.clearForm=function(){this.name.value="",this.email.value="",this.date.value="",this.removePopup()},t.prototype.removePopup=function(){var e=document.querySelector(".popup");document.body.removeChild(e)},e.Views.FormView=t}(App),function(e){"use strict";function t(e){this.el=document.createElement("THEAD"),this.el.className="tableHeader",this.collection=e.collection,this.sortBy=e.sortBy,this.reverse=e.reverse,this.table=e.table,this.renderOrder=["id","name","email","date","del","edit"],this.fields={id:function(){var e=document.createElement("TH");return e.id="id",e.dataset.sortBy="id",e.textContent="ID",e},name:function(){var e=document.createElement("TH");return e.id="name",e.dataset.sortBy="name",e.textContent="Name",e},email:function(){var e=document.createElement("TH");return e.id="email",e.dataset.sortBy="email",e.textContent="Email",e},date:function(){var e=document.createElement("TH");return e.id="date",e.dataset.sortBy="date",e.textContent="Estimated time",e},del:function(){var e=document.createElement("TH");return e.id="delete",e.textContent="Delete",e},edit:function(){var e=document.createElement("TH");return e.id="edit",e.textContent="Edit",e}},this.addHeaderListeners.call(this),this.render()}t.prototype.render=function(){for(var e=document.createElement("TR"),t=document.createDocumentFragment(),n=this.renderOrder,i=0;i<n.length;i++){var s=n[i];t.appendChild(this.fields[s]())}return e.appendChild(t),this.el.appendChild(e),this},t.prototype.addHeaderListeners=function(){this.el.addEventListener("click",this.headerFilterHandler.bind(this))},t.prototype.headerFilterHandler=function(e){function t(){for(var t=e.target.parentElement.children,n=0;n<t.length;n++)t[n].classList.remove("active")}return"TH"===e.target.tagName&&"delete"!==e.target.id&&"edit"!==e.target.id&&void("active"===e.target.className?this.table.tBody.triggerEvent("reverse"):(t(),e.target.classList.add("active"),this.table.tBody.triggerEvent("columnSort",e.target.dataset.sortBy)))},e.Views.HeaderItem=t}(App),function(e){"use strict";function t(){var e=new App.Views.AppLayout;e.loadUsers(),e.render()}e.addEventListener("DOMContentLoaded",t)}(document),function(e){"use strict";function t(){this.collection=[],this.loadingSettings={loadingInProgress:!1,page:0,pageSize:10,allPagesLoaded:!1},this.usersTable=new e.Views.TableView({collection:this.collection,settings:this.loadingSettings}),this.tBody=this.usersTable.tBody,this.button=document.createElement("BUTTON"),this.tBody.addEventListener("get",this.getUser.bind(this)),this.tBody.addEventListener("delete",this.deleteTableRow.bind(this)),this.tBody.addEventListener("loadingStart",this.loadUsers.bind(this))}t.prototype.deleteTableRow=function(t){0===this.collection.length?this.tBody.render():e.Request.deleteUser({success:this.eraseRow.bind(this),error:this.onError.bind(this)},{id:t})},t.prototype.eraseRow=function(e){this.tBody.triggerEvent("eraseRow",e)},t.prototype.getUser=function(t){var n=+t.dataset.id;e.Request.getUser({success:this.editModel.bind(this),error:this.onError.bind(this)},{id:n})},t.prototype.loadUsers=function(){var t=this;e.Request.loadUsers({success:t.onLoad.bind(t),error:t.onError.bind(t)},t.loadingSettings)},t.prototype.onLoad=function(t){var n=this;n.loadingSettings.totalItems=t.totalItems;var i=t.result,s=i.map(function(t){return new e.Models.User(t)});this.usersTable.tBody.triggerEvent("loadFinished",s)},t.prototype.onError=function(e){console.log(e)},t.prototype.createButton=function(){return this.button.className="addClient",this.button.textContent="Add Client",this.button.addEventListener("click",this.addClient.bind(this)),this.button},t.prototype.addClient=function(){var t=document.querySelector(".popup");if(t)return!1;var n=new e.Views.FormView({collection:this.collection,table:this.usersTable,loadingSettings:this.loadingSettings,model:{}});document.body.appendChild(n.render())},t.prototype.render=function(){document.body.appendChild(this.usersTable.render()),document.body.appendChild(this.createButton())},t.prototype.editModel=function(t){function n(){var e=document.querySelector(".popup");e.querySelector("h3").textContent="Edit",e.querySelector(".add-btn").style.display="none",e.querySelector(".edit-btn").style.display="inline"}var i=document.querySelector(".popup");if(i)return!1;var s=new e.Views.FormView({collection:this.collection,table:this.usersTable,model:t});document.body.appendChild(s.render()),n()},e.Views.AppLayout=t}(App,window),function(e){"use strict";var t="http://localhost:4000/",n="users",i="user";e.Request={loadUsers:function(i,s){return s=s||{},new e.Request.ServerRequest({method:"POST",URL:t+n,params:s,settings:i})},addUser:function(n,s){return new e.Request.ServerRequest({method:"POST",URL:t+i,settings:n,params:s})},deleteUser:function(n,s){return new e.Request.ServerRequest({method:"DELETE",URL:t+i,settings:n,params:s})},getUser:function(n,s){return new e.Request.ServerRequest({method:"GET",URL:t+i,settings:n,params:s})},editUser:function(n,s){return new e.Request.ServerRequest({method:"PUT",URL:t+i,settings:n,params:s})}}}(App),function(e){"use strict";function t(e){this.el=document.createElement("TR"),this.el.className="client",this.model=e.model,this.el.dataset.id=this.model.id,this.id=this.model.id,this.render()}t.prototype.templ=function(e,t){var n=t.createTemplate();e.appendChild(n)},t.prototype.render=function(){return this.templ(this.el,this.model),this},t.prototype.destroy=function(){this.model.timeView.stop(),this.el.parentElement.removeChild(this.el)},e.Views.RowItem=t}(App),function(e){"use strict";function t(e){this.xhr=new XMLHttpRequest,this.method=e.method,this.URL=e.URL,this.settings=e.settings,this.params=e.params,this.success=this.settings.success,this.error=this.settings.error,this.model=this.params.model,this.id=this.params.id,this.requestString=this.createRequestString(this.params),this.requestBody="";var t=this;this.actions={GET:function(){t.URL+="?"+t.requestString},POST:function(){t.model?t.requestBody=t.createRequestString(t.model):t.requestBody=t.requestString},PUT:function(){t.requestBody=t.createRequestString(t.model)},DELETE:function(){t.requestBody=t.requestString}},this.actions[this.method](),this.xhr.open(this.method,this.URL,!0),this.xhr.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),this.xhr.addEventListener("readystatechange",this.readyStateChangeHandler.bind(this)),this.xhr.send(this.requestBody)}t.prototype.createRequestString=function(e){var t="";for(var n in e)t+=n+"="+encodeURIComponent(e[n]+"")+"&";return t},t.prototype.readyStateChangeHandler=function(){if(4===this.xhr.readyState){if(!(this.xhr.status>=200&&this.xhr.status<300)){var e="error: "+(this.xhr.status?this.xhr.statusText:"problems with request");return this.error(e)}var t=JSON.parse(this.xhr.responseText);this.success(t)}},e.Request.ServerRequest=t}(App),function(e){"use strict";function t(t){e.Views.EventCollection.call(this),this.el=document.createElement("TBODY"),this.el.className="tableBody",this.collection=t.collection,this.loadingSettings=t.settings,this.table=t.table,this.rowItems=[],this.el.addEventListener("click",this.delEditHandlers.bind(this)),this.el.addEventListener("scroll",this.scrollHandler.bind(this)),this.addEventListener("loadFinished",this.updateTable.bind(this)),this.addEventListener("reverse",this.reverse.bind(this)),this.addEventListener("columnSort",this.sort.bind(this)),this.addEventListener("eraseRow",this.eraseRow.bind(this)),this.render()}t.prototype=Object.create(e.Views.EventCollection.prototype),t.prototype.scrollHandler=function(){clearTimeout(this.scrollTimerId);var e=this;this.scrollTimerId=setTimeout(function(){e.loadingSettings.loadingInProgress||e.el.scrollHeight-(e.el.scrollTop+e.el.offsetHeight)<=500&&(!e.loadingSettings.totalItems||e.loadingSettings.totalItems>(e.loadingSettings.page+1)*e.loadingSettings.pageSize?(e.loadingSettings.page++,e.triggerEvent("loadingStart")):e.loadingSettings.allPagesLoaded=!0)},200)},t.prototype.updateTable=function(e){var t=this;e.forEach(function(e){t.collection.push(e)}),this.render()},t.prototype.clearTBody=function(){this.el.innerHTML="",this.rowItems.length=0},t.prototype.render=function(){if(this.clearTBody(),0===this.collection.length)this.el.innerHTML='<tr class="dummy"><td colspan ="7">There is no more clients</td></tr>';else{var t=this,n=document.createDocumentFragment();this.collection.forEach(function(i){var s=new e.Views.RowItem({model:i,collection:t.collection});t.rowItems.push(s),n.appendChild(s.el)}),this.el.appendChild(n)}return this.el},t.prototype.reverse=function(){this.collection.reverse(),this.render()},t.prototype.sort=function(e){switch(e){case"id":this.collection.sort(function(t,n){return+t[e]-+n[e]});break;case"date":this.collection.sort(function(t,n){var i=Date.parse(t[e]),s=Date.parse(n[e]);return i-s});break;default:this.collection.sort(function(t,n){return t[e]>n[e]?1:-1})}this.render()},t.prototype.delEditHandlers=function(e){this.row=e.target.closest("TR");var t=+this.row.dataset.id;"delClient"===e.target.className&&this.triggerEvent("delete",t),"editClient"===e.target.className&&this.triggerEvent("get",this.row)},t.prototype.eraseRow=function(e){var t=this,n=this.findColIndex();10===this.collection.length&&t.scrollHandler();var i=this.findRowIndex();console.log("model with id: "+e.id+"was deleted"),this.collection.splice(n,1),this.rowItems[i].destroy(),this.rowItems.splice(i,1)},t.prototype.findRowIndex=function(){var e,t=this;return this.rowItems.forEach(function(n,i){+t.row.dataset.id===n.model.id&&(e=i)}),e},t.prototype.findColIndex=function(){var e,t=this;return this.collection.forEach(function(n,i){+t.row.dataset.id===n.id&&(e=i)}),e},e.Views.TableBody=t}(App),function(e){"use strict";function t(t){this.el=document.createElement("TABLE"),this.el.className="list",this.collection=t.collection,this.loadingSettings=t.settings,this.rowItems=[],this.tBody=new e.Views.TableBody({collection:this.collection,settings:this.loadingSettings,table:this}),this.header=new e.Views.HeaderItem({collection:this.collection,table:this})}t.prototype.addClient=function(e){this.collection.push(e),this.tBody.render()},t.prototype.render=function(){return this.createCaption(),this.el.appendChild(this.header.el),this.el.appendChild(this.tBody.render()),this.el},t.prototype.createCaption=function(){var e=document.createElement("CAPTION");e.textContent="Users List",this.el.appendChild(e)},e.Views.TableView=t}(App),function(e){"use strict";function t(t){this.model=t;var n=this;this.fields={id:function(){var e=document.createElement("TD");return e.className="client-id",e.textContent=t.id,e},name:function(){var e=document.createElement("TD");return e.className="client-name",e.textContent=t.name,e},email:function(){var e=document.createElement("TD");return e.className="client-email",e.textContent=t.email,e},date:function(){var i=document.createElement("TD");return i.className="client-date",n.model.timeView=new e.Views.EstimatedDateElement(t.date,i),i},del:function(){var e=document.createElement("TD");e.className="client-delete";var t=document.createElement("BUTTON");return t.className="delClient",t.textContent="Delete client",e.appendChild(t),e},edit:function(){var e=document.createElement("TD");e.className="edit-element";var t=document.createElement("BUTTON");return t.className="editClient",t.textContent="Edit client",e.appendChild(t),e}},this.orderFields=["id","name","email","date","del","edit"]}t.prototype.createTemplate=function(){for(var e=new DocumentFragment,t=this.orderFields,n=0;n<t.length;n++){var i=t[n];e.appendChild(this.fields[i]())}return e},e.Models.Template=t}(App),function(){"use strict";function e(e){this.id=e.id,this.name=e.name,this.admin=e.admin,this.email=e.email,this.date=e.date}e.prototype.createTemplate=function(){var e=new App.Models.Template(this);return e.createTemplate()},App.Models.User=e}();